import streamlit as st
import pandas as pd
import plotly.express as px
from datetime import datetime
import numpy as np

# ==================== ì„¤ì • ====================
st.set_page_config(page_title="ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ", layout="wide")

# CSS íŒŒì¼ ë¡œë“œ
def load_css(file_path):
    with open(file_path, encoding='utf-8') as f:
        st.markdown(f'<style>{f.read()}</style>', unsafe_allow_html=True)

try:
    load_css('style.css')
except FileNotFoundError:
    pass  # CSS íŒŒì¼ì´ ì—†ì–´ë„ ê³„ì† ì‹¤í–‰

st.title("ğŸ“Š ë§¤ì¶œê·¸ë˜í”„")

# ì„¸ì…˜ ì´ˆê¸°í™”
if 'df_original' not in st.session_state:
    st.session_state.df_original = None
    st.session_state.file_name = None

# ==================== íŒŒì¼ ì—…ë¡œë“œ ====================
st.sidebar.markdown("---")
st.sidebar.subheader("ğŸ“ íŒŒì¼ ì—…ë¡œë“œ")
uploaded_file = st.sidebar.file_uploader(
    "ì—‘ì…€ ë˜ëŠ” CSV íŒŒì¼",
    type=['xlsx', 'xls', 'csv']
)

# íŒŒì¼ ë¡œë“œ
if uploaded_file and st.session_state.file_name != uploaded_file.name:
    try:
        st.session_state.df_original = pd.read_csv(uploaded_file, encoding='utf-8-sig') if uploaded_file.name.endswith('.csv') else pd.read_excel(uploaded_file)
        st.session_state.file_name = uploaded_file.name  # íŒŒì¼ëª… ì €ì¥

    except Exception as e:
        st.sidebar.error(f"âŒ {e}")
        st.stop()
elif st.session_state.file_name:
    st.sidebar.info(f"ğŸ“‚ {st.session_state.file_name}")

if st.session_state.df_original is None:
    st.warning("âš ï¸ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")
    st.stop()

df = st.session_state.df_original.copy()

# ==================== ì»¬ëŸ¼ ë§¤í•‘ ====================
def auto_map_columns(dataframe):
    """ì»¬ëŸ¼ ìë™ ë§¤í•‘"""
    mapping = {}
    keywords = {
        'ì—°ë„': ['ì—°ë„', 'year', 'ë…„'],
        'ì›”': ['ì›”', 'month'],
        'êµ¬ë¶„': ['êµ¬ë¶„'],
        'ìˆ˜ìµì½”ë“œ': ['ìˆ˜ìµì½”ë“œ', 'revenue'],
        'ì‚¬ì—…ë¶€': ['ì‚¬ì—…ë¶€', 'division'],
        'ë¸Œëœë“œ': ['ë¸Œëœë“œ', 'brand'],
        'ìº í¼ìŠ¤': ['ìº í¼ìŠ¤', 'ì§€ì—­', 'campus', 'region']
    }
    
    for col in dataframe.columns:
        col_lower = str(col).lower().strip()
        for key, kws in keywords.items():
            if any(kw in col_lower for kw in kws):
                if key == 'êµ¬ë¶„' and 'êµ¬ë¶„' != col_lower:
                    continue
                mapping[key] = col
                break
    
    # ë§¤ì¶œ ì»¬ëŸ¼ ì°¾ê¸°
    for col in dataframe.columns:
        col_lower = str(col).lower()
        if 'ë§¤ì¶œ' in col_lower or 'sales' in col_lower:
            if 'ë§¤ì¶œ2' in col_lower or 'sales2' in col_lower:
                mapping['ë§¤ì¶œ2'] = col
            elif 'ë§¤ì¶œ' not in mapping:
                mapping['ë§¤ì¶œ'] = col
    
    return mapping

col_mapping = auto_map_columns(df)

if 'ë§¤ì¶œ' not in col_mapping:
    st.error("âŒ ë§¤ì¶œ ì»¬ëŸ¼ ì—†ìŒ")
    st.stop()

# ==================== ë°ì´í„° ì „ì²˜ë¦¬ ====================
def clean_numeric_column(series):
    """ìˆ«ì ì»¬ëŸ¼ ì •ë¦¬"""
    if series.dtype == 'object':
        series = series.apply(
            lambda x: str(x).replace(',', '').replace('ì›', '').strip()
            if pd.notna(x) and str(x).strip() not in ['-', ''] else None
        )
    return pd.to_numeric(series, errors='coerce')

# ë§¤ì¶œ ì»¬ëŸ¼ ì •ë¦¬
df[col_mapping['ë§¤ì¶œ']] = clean_numeric_column(df[col_mapping['ë§¤ì¶œ']])
if 'ë§¤ì¶œ2' in col_mapping:
    df[col_mapping['ë§¤ì¶œ2']] = clean_numeric_column(df[col_mapping['ë§¤ì¶œ2']])

# ì—°ë„ ì²˜ë¦¬
if 'ì—°ë„' not in col_mapping:
    st.error("âŒ ì—°ë„ ì»¬ëŸ¼ ì—†ìŒ")
    st.stop()

df['ì—°ë„_ì²˜ë¦¬'] = df[col_mapping['ì—°ë„']].apply(
    lambda x: int(x) + 2000 if pd.notna(x) and int(x) < 100 else int(x) if pd.notna(x) else None
)

# NaN ì œê±°
df_clean = df[df[col_mapping['ë§¤ì¶œ']].notna()].copy()
sales_col = col_mapping.get('ë§¤ì¶œ2') or col_mapping['ë§¤ì¶œ']

# ==================== í•„í„° í•¨ìˆ˜ ====================
def apply_filters(data, year=None, month=None, up_to_month=False, **kwargs):
    """í•„í„° ì ìš©"""
    result = data.copy()
    
    if year is not None:
        result = result[result['ì—°ë„_ì²˜ë¦¬'] == year]
    
    if month is not None:
        result = result[result[col_mapping['ì›”']] <= month] if up_to_month else result[result[col_mapping['ì›”']] == month]
    
    # ì„ íƒì  í•„í„°
    for key, values in kwargs.items():
        if values and len(values) > 0 and key in col_mapping:
            result = result[result[col_mapping[key]].isin(values)]
    
    return result

# ==================== ì‚¬ì´ë“œë°” í•„í„° ====================
years = sorted([y for y in df_clean['ì—°ë„_ì²˜ë¦¬'].unique() if pd.notna(y)])
months = sorted([m for m in df_clean[col_mapping['ì›”']].unique() if pd.notna(m)])

st.sidebar.header("ğŸ“… ê¸°ê°„ ì„ íƒ")

# ì—°ë„ ì„ íƒ (multiselectë¡œ ë³€ê²½, ë‹¨ì¼ ì„ íƒë§Œ í—ˆìš©)
selected_years = st.sidebar.multiselect(
    "ğŸ“… ì—°ë„",
    years,
    default=[years[-1]] if years else [],
    help="ì—°ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”"
)
selected_year = selected_years[0] if selected_years else (years[-1] if years else None)

# ì›” ì„ íƒ (multiselectë¡œ ë³€ê²½, ë‹¨ì¼ ì„ íƒë§Œ í—ˆìš©)
selected_months = st.sidebar.multiselect(
    "ğŸ“† ì›”",
    months,
    default=[months[-1]] if months else [],
    help="ì›”ì„ ì„ íƒí•˜ì„¸ìš”"
)
selected_month = selected_months[0] if selected_months else (months[-1] if months else None)

st.sidebar.divider()
st.sidebar.header("ğŸ“… ë¹„êµ ê¸°ê°„ ì„ íƒ")

comparison_years = st.sidebar.multiselect(
    "ğŸ“… ë¹„êµ ì—°ë„",
    years,
    default=[y for y in years if y != selected_year][:2] if len(years) > 1 else [],
    help="ë¹„êµí•  ì—°ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”"
)

comparison_months = st.sidebar.multiselect(
    "ğŸ“† ë¹„êµ ì›”",
    months,
    default=[selected_month],
    help="ë¹„êµí•  ì›”ì„ ì„ íƒí•˜ì„¸ìš”"
)

if not comparison_years and len(years) > 0:
    # ë¹„êµ ì—°ë„ê°€ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš°, ì„ íƒ ì—°ë„ë¥¼ ì œì™¸í•œ ì²« ë²ˆì§¸ ì—°ë„ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ
    other_years = [y for y in years if y != selected_year]
    if other_years:
        comparison_years = [other_years[0]]

st.sidebar.divider()
st.sidebar.header("ğŸ” ì¶”ê°€ í•„í„°")

# ë™ì  í•„í„° ìƒì„±
filters = {}
filter_configs = [
    ('ì‚¬ì—…ë¶€', 'ğŸ¢ ì‚¬ì—…ë¶€'),
    ('ë¸Œëœë“œ', 'ğŸ·ï¸ ë¸Œëœë“œ'),
    ('ìº í¼ìŠ¤', 'ğŸ« ìº í¼ìŠ¤')
]

for key, label in filter_configs:
    if key in col_mapping and col_mapping[key] in df_clean.columns:
        options = sorted([x for x in df_clean[col_mapping[key]].unique() if pd.notna(x)])
        filters[key] = st.sidebar.multiselect(label, options, default=[], help="ì „ì²´ ë˜ëŠ” ë‹¤ì¤‘ì„ íƒ")

# ==================== íƒ€ì´í‹€ ì•„ë˜ í•„í„° ì •ë³´ í‘œì‹œ ====================
# ê°„ê²°í•œ í˜•ì‹: "25ë…„ 11ì›” ì¤‘ë“± ìˆ˜ì•„+ë”ë¸”ë™ ìˆ˜ë‚´"
filter_parts = [f"{selected_year % 100}ë…„ {selected_month}ì›”"]
for key in ['ì‚¬ì—…ë¶€', 'ë¸Œëœë“œ', 'ìº í¼ìŠ¤']:
    if key in filters and filters[key]:
        filter_parts.append(' + '.join(map(str, filters[key])))

st.markdown(f"### {' '.join(filter_parts)}")

# ==================== ë©”ì¸ í™”ë©´ ====================
st.divider()

# ==================== 1. ì›”ë³„ ë§¤ì¶œ ì¶”ì„¸ ====================
st.subheader("1ï¸âƒ£ ì›”ë³„ ë§¤ì¶œ ì¶”ì„¸")

chart_data = []

# ë©”ì¸ ì—°ë„ (1ì›”~ì„ íƒì›”)
for m in range(1, selected_month + 1):
    data = apply_filters(df_clean, selected_year, m, **filters)
    chart_data.append({'ì›”': m, 'ì—°ë„': f'{selected_year}ë…„ (ë©”ì¸)', 'ë§¤ì¶œ': data[sales_col].sum() / 1000000})  # ë°±ë§Œì› ë‹¨ìœ„

# ë¹„êµ ì—°ë„ (1~12ì›”)
for y in comparison_years:
    for m in range(1, 13):
        data = apply_filters(df_clean, y, m, **filters)
        chart_data.append({'ì›”': m, 'ì—°ë„': f'{y}ë…„', 'ë§¤ì¶œ': data[sales_col].sum() / 1000000})  # ë°±ë§Œì› ë‹¨ìœ„

chart_df = pd.DataFrame(chart_data)

if len(chart_df) > 0:
    fig = px.line(chart_df, x='ì›”', y='ë§¤ì¶œ', color='ì—°ë„', markers=True, title='ì›”ë³„ ë§¤ì¶œ ì¶”ì„¸ (ë‹¨ìœ„: ë°±ë§Œì›)')
    fig.update_layout(
        height=1000,
        hovermode='x unified',
        yaxis=dict(
            tickformat=',.0f',
            title='ë§¤ì¶œ (ë°±ë§Œì›)'
        ),
        xaxis=dict(
            tickmode='linear',
            tick0=1,
            dtick=1,  # 1ì›”ë¶€í„° 12ì›”ê¹Œì§€ ëª¨ë‘ í‘œì‹œ
            range=[0.5, 12.5]
        ),
        legend=dict(
            orientation='h',  # ê°€ë¡œ ë°©í–¥
            yanchor='bottom',
            y=1.02,  # ê·¸ë˜í”„ ìœ„ìª½
            xanchor='center',
            x=0.5,
            font=dict(size=50)  # ë²”ë¡€ ê¸€ì”¨ í¬ê¸°
        )
    )
    fig.update_traces(line=dict(width=5), marker=dict(size=10), hovertemplate='%{y:,.0f}ë°±ë§Œì›<extra></extra>')
    st.plotly_chart(fig, use_container_width=True)

st.divider()

# ==================== 2. ë¹„êµì›” ë§¤ì¶œ ë¹„êµ ====================
st.subheader("2ï¸âƒ£ ì „ì›”/ì›” ë§¤ì¶œ ë¹„êµ")

# êµ¬ë¶„ ì»¬ëŸ¼ ê°’ ìƒì„± (ì¶”ê°€ í•„í„°ì—ì„œ ì„ íƒëœ ê°’ë“¤)
gubun_parts = []
for key in ['ì‚¬ì—…ë¶€', 'ë¸Œëœë“œ', 'ìº í¼ìŠ¤']:
    if key in filters and filters[key]:
        gubun_parts.extend(filters[key])
gubun_subtitle = ' '.join(gubun_parts) if gubun_parts else ''

# ì„œë¸Œíƒ€ì´í‹€ í‘œì‹œ
if gubun_subtitle:
    st.markdown(f"**{gubun_subtitle}**")

# ë¹„êµì›” ë§¤ì¶œ (ë¹„êµ ì›”ë“¤ì˜ í•©ì‚°)
comp_months_str = ' + '.join([f'{m}ì›”' for m in sorted(comparison_months)])

# ì„ íƒ ì—°ë„ ê¸°ì¤€ìœ¼ë¡œ 3ê°œë…„ í‘œ ìƒì„± (ì„ íƒë…„, ì„ íƒë…„-1, ì„ íƒë…„-2)
for i in range(3):
    y = selected_year - i

    # í•´ë‹¹ ì—°ë„ì˜ ì„ íƒ ì›” ë§¤ì¶œ (ê° í‘œë§ˆë‹¤ ë‹¤ë¥¸ ì—°ë„ì˜ ê°’)
    main_sales_year = apply_filters(df_clean, y, selected_month, **filters)[sales_col].sum()

    # ë¹„êµì›”ì´ 12ì›”ì´ë©´ ì „ë…„ë„ 12ì›”, ì•„ë‹ˆë©´ í•´ë‹¹ ì—°ë„ì˜ ë¹„êµì›”ë“¤
    if comparison_months == [12]:
        # 12ì›”ë§Œ ì„ íƒí•œ ê²½ìš° ì „ë…„ë„ 12ì›”
        comp_sales = apply_filters(df_clean, y - 1, 12, **filters)[sales_col].sum()
        comp_year_display = f"{(y-1) % 100}ë…„"
        comp_month_display = "12ì›”"
    else:
        # ë‹¤ë¥¸ ì›”ë“¤ì˜ í•©ì‚°
        comp_sales = sum(
            apply_filters(df_clean, y, m, **filters)[sales_col].sum()
            for m in comparison_months
        )
        comp_year_display = f"{y % 100}ë…„"
        comp_month_display = comp_months_str

    diff = main_sales_year - comp_sales
    diff_pct = (diff / comp_sales * 100) if comp_sales > 0 else 0

    # HTML í…Œì´ë¸” ìƒì„± (2ì¤„ í—¤ë”) - ê³ ì • ë„ˆë¹„ ì„¤ì •
    html_table = '<table style="width: 100%; table-layout: fixed;"><thead>'
    # ì²« ë²ˆì§¸ í—¤ë” ì¤„: â‘ , â‘¡, â‘  - â‘¡
    html_table += '<tr>'
    html_table += '<th rowspan="2" style="width: 10%;">ë…„</th>'
    html_table += '<th style="width: 20%;">â‘ </th>'
    html_table += '<th style="width: 20%;">â‘¡</th>'
    html_table += '<th colspan="2" style="width: 50%;">â‘  - â‘¡</th>'
    html_table += '</tr>'
    # ë‘ ë²ˆì§¸ í—¤ë” ì¤„: ì‹¤ì œ ì›” ì •ë³´
    html_table += '<tr>'
    html_table += f'<th>{selected_month}ì›”</th>'
    html_table += f'<th>{comp_month_display}</th>'
    html_table += '<th style="width: 25%;">ì¦ê°ì•¡</th>'
    html_table += '<th style="width: 25%;">ì¦ê°ë¥ </th>'
    html_table += '</tr></thead><tbody>'

    # ë°ì´í„° í–‰
    html_table += '<tr>'
    html_table += f'<td>{y % 100}</td>'  # ë…„ë„
    html_table += f'<td>{main_sales_year:,.0f}</td>'  # â‘  (ì› ë‹¨ìœ„)
    html_table += f'<td>{comp_sales:,.0f}</td>'  # â‘¡ (ì› ë‹¨ìœ„)

    # ì¦ê°ì•¡ (ë¹¨ê°„ìƒ‰ í‘œì‹œ)
    diff_color = 'color: red;' if diff < 0 else ''
    html_table += f'<td style="{diff_color}">{diff:+,.0f}</td>'

    # ì¦ê°ë¥  (ë¹¨ê°„ìƒ‰ í‘œì‹œ)
    pct_color = 'color: red;' if diff_pct < 0 else ''
    html_table += f'<td style="{pct_color}">{diff_pct:+.1f}%</td>'

    html_table += '</tr></tbody></table>'
    st.markdown(html_table, unsafe_allow_html=True)

st.divider()

# ==================== 3. ë™ê¸°ê°„ ë§¤ì¶œ ë¹„êµ ====================
st.subheader("3ï¸âƒ£ ë™ê¸°ê°„ ë§¤ì¶œ ë¹„êµ")

main_sales = apply_filters(df_clean, selected_year, selected_month, **filters)[sales_col].sum()

for y in sorted(comparison_years, reverse=True):
    comp_sales = apply_filters(df_clean, y, selected_month, **filters)[sales_col].sum()
    diff = main_sales - comp_sales
    diff_pct = (diff / comp_sales * 100) if comp_sales > 0 else 0

    # ê°œë³„ í‘œ ìƒì„±
    st.markdown(f"#### {selected_year % 100}ë…„ vs {y % 100}ë…„ {selected_month}ì›”")

    comparison_data = pd.DataFrame([{
        f'{selected_year % 100}ë…„': f'{main_sales:,.0f}ì›',
        f'{y % 100}ë…„': f'{comp_sales:,.0f}ì›',
        'ì¦ê°ì•¡': f'{diff:+,.0f}ì›',
        'ì¦ê°ë¥ ': f'{diff_pct:+.1f}%'
    }])

    # HTML í…Œì´ë¸” ìƒì„± (CSS ìŠ¤íƒ€ì¼ ì ìš©)
    html_table = '<table><thead><tr>'
    for col in comparison_data.columns:
        html_table += f'<th>{col}</th>'
    html_table += '</tr></thead><tbody>'

    for _, row in comparison_data.iterrows():
        html_table += '<tr>'
        for col in comparison_data.columns:
            val = str(row[col])
            color_style = 'color: red;' if (col in ['ì¦ê°ì•¡', 'ì¦ê°ë¥ '] and (val.startswith('-') or val.startswith('âˆ’'))) else ''
            html_table += f'<td style="{color_style}">{val}</td>'
        html_table += '</tr>'

    html_table += '</tbody></table>'
    st.markdown(html_table, unsafe_allow_html=True)

st.divider()

# ==================== 4. ëˆ„ì  ë§¤ì¶œ ë¹„êµ ====================
st.subheader("4ï¸âƒ£ ëˆ„ì  ë§¤ì¶œ ë¹„êµ")

main_cum = apply_filters(df_clean, selected_year, selected_month, up_to_month=True, **filters)[sales_col].sum()

# ê·¸ë˜í”„ ë°ì´í„°
graph_data = [{'ì—°ë„': f'{selected_year % 100}ë…„', 'ëˆ„ì ë§¤ì¶œ': main_cum}]

# ê°œë³„ í‘œ ìƒì„±
for y in sorted(comparison_years, reverse=True):
    comp_cum = apply_filters(df_clean, y, selected_month, up_to_month=True, **filters)[sales_col].sum()
    diff = main_cum - comp_cum
    diff_pct = (diff / comp_cum * 100) if comp_cum > 0 else 0

    graph_data.append({'ì—°ë„': f'{y % 100}ë…„', 'ëˆ„ì ë§¤ì¶œ': comp_cum})

    # ê°œë³„ í‘œ ìƒì„±
    st.markdown(f"#### {selected_year % 100}ë…„ ({selected_month}ì›”ê¹Œì§€ ëˆ„ì ) vs {y % 100}ë…„ ({selected_month}ì›”ê¹Œì§€ ëˆ„ì )")

    comparison_data = pd.DataFrame([{
        f'{selected_year % 100}ë…„ ëˆ„ì ': f'{main_cum:,.0f}ì›',
        f'{y % 100}ë…„ ëˆ„ì ': f'{comp_cum:,.0f}ì›',
        'ì¦ê°ì•¡': f'{diff:+,.0f}ì›',
        'ì¦ê°ë¥ ': f'{diff_pct:+.1f}%'
    }])

    # HTML í…Œì´ë¸” ìƒì„± (CSS ìŠ¤íƒ€ì¼ ì ìš©)
    html_table = '<table><thead><tr>'
    for col in comparison_data.columns:
        html_table += f'<th>{col}</th>'
    html_table += '</tr></thead><tbody>'

    for _, row in comparison_data.iterrows():
        html_table += '<tr>'
        for col in comparison_data.columns:
            val = str(row[col])
            color_style = 'color: red;' if (col in ['ì¦ê°ì•¡', 'ì¦ê°ë¥ '] and (val.startswith('-') or val.startswith('âˆ’'))) else ''
            html_table += f'<td style="{color_style}">{val}</td>'
        html_table += '</tr>'

    html_table += '</tbody></table>'
    st.markdown(html_table, unsafe_allow_html=True)

# ëˆ„ì  ë§¤ì¶œ ê·¸ë˜í”„
st.markdown("#### ğŸ“Š ëˆ„ì  ë§¤ì¶œ ê·¸ë˜í”„")
graph_df = pd.DataFrame(graph_data)

# ë°±ë§Œì› ë‹¨ìœ„ë¡œ ë³€í™˜
graph_df['ëˆ„ì ë§¤ì¶œ_ë°±ë§Œ'] = graph_df['ëˆ„ì ë§¤ì¶œ'] / 1000000

# ë§‰ëŒ€ ê·¸ë˜í”„ ìƒì„±
fig = px.bar(graph_df, x='ì—°ë„', y='ëˆ„ì ë§¤ì¶œ_ë°±ë§Œ', text='ëˆ„ì ë§¤ì¶œ_ë°±ë§Œ', color='ëˆ„ì ë§¤ì¶œ_ë°±ë§Œ', color_continuous_scale='Blues')
fig.update_traces(texttemplate='%{y:,.0f}ë°±ë§Œì›', textposition='outside', name='ëˆ„ì ë§¤ì¶œ')

# êº¾ì€ì„  ê·¸ë˜í”„ ì¶”ê°€
import plotly.graph_objects as go
fig.add_trace(go.Scatter(
    x=graph_df['ì—°ë„'],
    y=graph_df['ëˆ„ì ë§¤ì¶œ_ë°±ë§Œ'],
    mode='lines+markers',
    name='ì¶”ì„¸ì„ ',
    line=dict(color='red', width=4),
    marker=dict(size=12, color='red'),
    yaxis='y'
))

fig.update_layout(
    height=800,
    showlegend=True,
    legend=dict(
        orientation='h',
        yanchor='bottom',
        y=1.02,
        xanchor='center',
        x=0.5,
        font=dict(size=30)
    ),
    yaxis=dict(
        tickformat=',.0f',
        title='ëˆ„ì ë§¤ì¶œ (ë°±ë§Œì›)',
        rangemode='tozero',  # 0ë¶€í„° ì‹œì‘
        dtick=1000  # 1000ë°±ë§Œì›(ì‹­ì–µ) ë‹¨ìœ„ ê°„ê²©
    )
)
st.plotly_chart(fig, use_container_width=True)

st.divider()

# ==================== 5. ì¶”ê°€ ë¶„ì„ ====================
tab1, tab2, tab3, tab4 = st.tabs(["ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ (ì„ íƒì›”)", "ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ (ëˆ„ì )", "ğŸ“ˆ ì›”ë³„ ìƒì„¸", "ğŸ“‹ ì›ë³¸ ë°ì´í„°"])

with tab1:
    st.markdown(f"#### {selected_year}ë…„ {selected_month}ì›” ì¹´í…Œê³ ë¦¬ë³„ ë§¤ì¶œ")
    # ì„ íƒí•œ ì›”ë§Œì˜ ë°ì´í„°
    current_month_data = apply_filters(df_clean, selected_year, selected_month, up_to_month=False, **filters)

    charts = []
    for key, title, color in [('ì‚¬ì—…ë¶€', 'ì‚¬ì—…ë¶€ë³„', 'pie'), ('ë¸Œëœë“œ', 'ë¸Œëœë“œë³„', 'Blues'), ('ìº í¼ìŠ¤', 'ìº í¼ìŠ¤ë³„', 'Greens')]:
        if key in col_mapping and col_mapping[key] in current_month_data.columns:
            agg = current_month_data.groupby(col_mapping[key])[sales_col].sum().reset_index().sort_values(sales_col, ascending=False)
            # ë°±ë§Œì› ë‹¨ìœ„ë¡œ ë³€í™˜
            agg[f'{sales_col}_ë°±ë§Œ'] = agg[sales_col] / 1000000
            charts.append((key, title, agg, color))

    cols = st.columns(3)
    for i, (key, title, agg, color) in enumerate(charts[:3]):
        with cols[i]:
            if color == 'pie':
                fig = px.pie(agg, values=f'{sales_col}_ë°±ë§Œ', names=col_mapping[key], title=f'{title} ë§¤ì¶œ (ë°±ë§Œì›)')
                fig.update_traces(texttemplate='%{value:,.0f}ë°±ë§Œì›')
                fig.update_layout(height=800)
            else:
                fig = px.bar(agg, x=col_mapping[key], y=f'{sales_col}_ë°±ë§Œ', title=f'{title} ë§¤ì¶œ (ë°±ë§Œì›)', color=f'{sales_col}_ë°±ë§Œ', color_continuous_scale=color)
                fig.update_traces(texttemplate='%{y:,.0f}ë°±ë§Œì›', textposition='outside')
                fig.update_layout(
                    height=800,
                    yaxis=dict(
                        tickformat=',.0f',
                        title='ë§¤ì¶œ (ë°±ë§Œì›)'
                    )
                )
            st.plotly_chart(fig, use_container_width=True)

with tab2:
    st.markdown(f"#### {selected_year}ë…„ 1ì›”~{selected_month}ì›” ëˆ„ì  ì¹´í…Œê³ ë¦¬ë³„ ë§¤ì¶œ")
    # ëˆ„ì  ë°ì´í„°
    cumulative_data = apply_filters(df_clean, selected_year, selected_month, up_to_month=True, **filters)

    charts_cum = []
    for key, title, color in [('ì‚¬ì—…ë¶€', 'ì‚¬ì—…ë¶€ë³„', 'pie'), ('ë¸Œëœë“œ', 'ë¸Œëœë“œë³„', 'Blues'), ('ìº í¼ìŠ¤', 'ìº í¼ìŠ¤ë³„', 'Greens')]:
        if key in col_mapping and col_mapping[key] in cumulative_data.columns:
            agg = cumulative_data.groupby(col_mapping[key])[sales_col].sum().reset_index().sort_values(sales_col, ascending=False)
            # ë°±ë§Œì› ë‹¨ìœ„ë¡œ ë³€í™˜
            agg[f'{sales_col}_ë°±ë§Œ'] = agg[sales_col] / 1000000
            charts_cum.append((key, title, agg, color))

    cols = st.columns(3)
    for i, (key, title, agg, color) in enumerate(charts_cum[:3]):
        with cols[i]:
            if color == 'pie':
                fig = px.pie(agg, values=f'{sales_col}_ë°±ë§Œ', names=col_mapping[key], title=f'{title} ë§¤ì¶œ (ë°±ë§Œì›)')
                fig.update_traces(texttemplate='%{value:,.0f}ë°±ë§Œì›')
                fig.update_layout(height=800)
            else:
                fig = px.bar(agg, x=col_mapping[key], y=f'{sales_col}_ë°±ë§Œ', title=f'{title} ë§¤ì¶œ (ë°±ë§Œì›)', color=f'{sales_col}_ë°±ë§Œ', color_continuous_scale=color)
                fig.update_traces(texttemplate='%{y:,.0f}ë°±ë§Œì›', textposition='outside')
                fig.update_layout(
                    height=800,
                    yaxis=dict(
                        tickformat=',.0f',
                        title='ë§¤ì¶œ (ë°±ë§Œì›)'
                    )
                )
            st.plotly_chart(fig, use_container_width=True)

with tab3:
    monthly_detail = []
    for m in range(1, selected_month + 1):
        row = {'ì›”': f'{m}ì›”', f'{selected_year}ë…„': apply_filters(df_clean, selected_year, m, **filters)[sales_col].sum()}
        for y in sorted(comparison_years, reverse=True):
            row[f'{y}ë…„'] = apply_filters(df_clean, y, m, **filters)[sales_col].sum()
        monthly_detail.append(row)

    detail_df = pd.DataFrame(monthly_detail)
    for col in detail_df.columns:
        if col != 'ì›”':
            detail_df[col] = detail_df[col].apply(lambda x: f'{x:,.0f}')

    st.markdown("#### ğŸ“‹ ì›”ë³„ ë§¤ì¶œ ìƒì„¸ (ì›)")
    st.dataframe(detail_df, use_container_width=True, hide_index=True)

with tab4:
    data = apply_filters(df_clean, selected_year, selected_month, up_to_month=True, **filters)
    st.dataframe(data, use_container_width=True, height=400)

    csv = data.to_csv(index=False, encoding='utf-8-sig')
    st.download_button(
        "ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ",
        csv,
        f"ë§¤ì¶œ_{selected_year}_{selected_month}_{datetime.now().strftime('%Y%m%d')}.csv",
        "text/csv"
    )

st.divider()
st.caption(f"ğŸ“Š {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")